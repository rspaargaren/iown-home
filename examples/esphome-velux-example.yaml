# Example ESPHome configuration for io-homecontrol / Velux devices
# This example demonstrates how to control Velux blinds and windows
# using an ESP32 with SX1276 LoRa module (e.g., Heltec WiFi LoRa 32 V2)

substitutions:
  device_name: velux-bridge
  friendly_name: "Velux Bridge"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  platform: ESP32
  board: heltec_wifi_lora_32_V2

  # Platform-specific configuration
  platformio_options:
    lib_deps:
      - jgromes/RadioLib@^6.6.0

# WiFi configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot
  ap:
    ssid: "${device_name} Fallback"
    password: !secret ap_password

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# Enable Over-The-Air updates
ota:
  password: !secret ota_password

# Enable logging
logger:
  level: DEBUG
  logs:
    iohomecontrol: VERBOSE
    iohomecontrol.cover: DEBUG

# Enable web server for diagnostics
web_server:
  port: 80

# External component (use local path during development)
external_components:
  - source:
      type: local
      path: ../components
    components: [iohomecontrol]

# SPI configuration (required for LoRa module)
spi:
  clk_pin: GPIO5
  miso_pin: GPIO19
  mosi_pin: GPIO27

# io-homecontrol component configuration
iohomecontrol:
  # SPI pins for SX1276/RFM95
  cs_pin: GPIO18
  irq_pin: GPIO26   # DIO0
  rst_pin: GPIO14

  # Your controller's node ID (3 bytes)
  # You can choose any unused ID, e.g., "ABCDEF"
  node_id: "0xABCDEF"

  # System key (16 bytes)
  # IMPORTANT: Replace with your actual system key from pairing
  # This example uses a placeholder key
  system_key: "E994BACFE6BED7667630EAE475BAAE95"

  # Operating frequency (MHz)
  # Channel 2 (868.95 MHz) is the primary 1W/2W channel
  frequency: 868.95

  # Protocol mode: 1W (one-way) or 2W (two-way)
  # Most Velux devices use 1W mode
  mode: 1W

  # Enable verbose logging for debugging
  verbose: true

# Cover entities for Velux devices
cover:
  # Example 1: Velux roof window
  - platform: iohomecontrol
    name: "Dachfenster Schlafzimmer"
    node_id: "0x646575"  # Replace with your device's node ID
    device_type: window_opener
    id: bedroom_window

  # Example 2: Velux roller blind
  - platform: iohomecontrol
    name: "Rollo Wohnzimmer"
    node_id: "0x123456"  # Replace with your device's node ID
    device_type: roller_shutter
    id: living_room_blind

  # Example 3: Velux exterior blind
  - platform: iohomecontrol
    name: "Außenrollo Küche"
    node_id: "0xABCDEF"  # Replace with your device's node ID
    device_type: exterior_blind
    id: kitchen_exterior_blind

# Optional: Sensors for RF signal quality
sensor:
  # RSSI sensor (signal strength)
  - platform: template
    name: "io-homecontrol RSSI"
    unit_of_measurement: "dBm"
    device_class: signal_strength
    state_class: measurement
    lambda: |-
      return -80.0; // Placeholder - implement RSSI reading from controller

  # WiFi signal sensor
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

# Binary sensors
binary_sensor:
  # Status indicator
  - platform: status
    name: "${friendly_name} Status"

# Buttons for manual testing
button:
  # Restart button
  - platform: restart
    name: "${friendly_name} Restart"

# Text sensors
text_sensor:
  # ESPHome version
  - platform: version
    name: "${friendly_name} ESPHome Version"

  # WiFi info
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"
    ssid:
      name: "${friendly_name} WiFi SSID"

# Switch for verbose logging toggle
switch:
  - platform: template
    name: "io-homecontrol Verbose Logging"
    optimistic: true
    turn_on_action:
      - logger.log:
          level: INFO
          message: "Verbose logging enabled"
    turn_off_action:
      - logger.log:
          level: INFO
          message: "Verbose logging disabled"

# Optional: Automations
# Example: Open bedroom window at sunrise
automation:
  - id: open_window_sunrise
    alias: "Open bedroom window at sunrise"
    trigger:
      - platform: sun
        event: sunrise
    action:
      - cover.open: bedroom_window

  - id: close_blind_sunset
    alias: "Close living room blind at sunset"
    trigger:
      - platform: sun
        event: sunset
    action:
      - cover.close: living_room_blind
